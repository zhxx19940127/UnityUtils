# 拦截器使用指南

## 📋 概述

我们为您的事件系统创建了一套完整的拦截器组件，提供了强大的消息过滤、验证、监控和管理功能。这套拦截器系统包含了以下组件：

### 🔧 拦截器组件

1. **ParameterValidationInterceptor** - 参数验证拦截器
2. **RateLimitInterceptor** - 频率限制拦截器  
3. **AuthenticationInterceptor** - 权限检查拦截器
4. **ConditionalInterceptor** - 条件拦截器
5. **LoggingInterceptor** - 日志拦截器
6. **InterceptorSetup** - 拦截器管理辅助类

## 🚀 快速开始

### 1. 使用InterceptorSetup（推荐）

最简单的方式是使用 `InterceptorSetup` 组件：

```csharp
// 在场景中添加InterceptorSetup组件到任何GameObject上
// 组件会在Start()时自动配置所有拦截器

// 或者手动创建
var setupGO = new GameObject("InterceptorSetup");
var setup = setupGO.AddComponent<InterceptorSetup>();

// 应用不同的配置模式
setup.ApplyDevelopmentConfiguration();  // 开发模式
setup.ApplyProductionConfiguration();   // 生产模式  
setup.ApplyDebugConfiguration();        // 调试模式
```

### 2. 手动配置拦截器

```csharp
using EventSystem.Interceptors;

var eventBus = Message.Instance;

// 1. 添加权限检查拦截器
var authInterceptor = new AuthenticationInterceptor();
eventBus.AddInterceptor(authInterceptor);

// 2. 添加参数验证拦截器
var paramValidator = new ParameterValidationInterceptor();
eventBus.AddInterceptor(paramValidator);

// 3. 添加频率限制拦截器
var rateLimit = new RateLimitInterceptor(100); // 100ms最小间隔
eventBus.AddInterceptor(rateLimit);

// 4. 添加日志拦截器
var logger = new LoggingInterceptor(LoggingInterceptor.LogLevel.Info);
eventBus.AddInterceptor(logger);
```

## 📖 详细使用说明

### 🔐 AuthenticationInterceptor - 权限检查

```csharp
// 创建自定义权限提供者
var permissionProvider = new DefaultUserPermissionProvider
{
    IsAdmin = true,
    IsLoggedIn = true,
    Username = "admin"
};

// 添加用户权限
permissionProvider.UserPermissions.Add("SystemAccess");
permissionProvider.UserPermissions.Add("DatabaseAccess");

// 创建权限拦截器
var authInterceptor = new AuthenticationInterceptor(permissionProvider);

// 配置需要权限的消息
authInterceptor.AddAdminRequiredMessage("AdminCommand");
authInterceptor.AddLoginRequiredMessage("SaveProfile");
authInterceptor.AddSpecialPermissionMessage("BackupData", "DataBackup");

// 添加到事件总线
eventBus.AddInterceptor(authInterceptor);

// 测试权限检查
eventBus.Post("AdminCommand", "test");  // 需要管理员权限
eventBus.Post("SaveProfile", userData); // 需要登录
```

### ✅ ParameterValidationInterceptor - 参数验证

```csharp
var validator = new ParameterValidationInterceptor();
eventBus.AddInterceptor(validator);

// 自动验证预定义消息
eventBus.Post("UserLogin", "username", "password");     // ✅ 通过验证
eventBus.Post("UserLogin", "username");                 // ❌ 参数不足，被拦截
eventBus.Post("SaveData", userData);                    // ✅ 通过验证
eventBus.Post("SaveData", null);                        // ❌ 数据为null，被拦截
```

### ⏱️ RateLimitInterceptor - 频率限制

```csharp
// 创建频率限制拦截器
var rateLimit = new RateLimitInterceptor(100); // 默认100ms间隔

// 设置自定义频率规则
rateLimit.SetCustomInterval("UI_Click", 50);        // UI点击：50ms
rateLimit.SetCustomInterval("SaveData", 5000);      // 保存数据：5秒
rateLimit.SetCustomInterval("NetworkRequest", 200); // 网络请求：200ms

eventBus.AddInterceptor(rateLimit);

// 测试频率限制
eventBus.Post("UI_Click", "button1");  // ✅ 第一次点击通过
eventBus.Post("UI_Click", "button1");  // ❌ 间隔不足50ms，被拦截

// 获取统计信息
var stats = rateLimit.GetCallStatistics();
rateLimit.PrintStatisticsReport();
```

### 🎯 ConditionalInterceptor - 条件拦截

```csharp
var conditional = new ConditionalInterceptor();

// 添加黑名单消息
conditional.AddToBlocklist("TestMessage");
conditional.AddToBlocklist("DebugMessage");

// 添加白名单模式
conditional.UseWhitelistMode = true;
conditional.AddToAllowlist("ImportantMessage");

// 添加时间规则
conditional.AddTimeBasedRule("NotificationSound", 22, 8, true); // 夜间22:00-08:00禁用声音

// 添加自定义条件
conditional.AddCustomCondition("HighPerformanceOperation", (parameters) =>
{
    // 当帧率低于30fps时拦截高性能操作
    return 1f / Time.deltaTime < 30f;
});

eventBus.AddInterceptor(conditional);

// 运行时控制
conditional.IsEnabled = false;  // 临时禁用拦截器
conditional.SetConditionalInterceptorEnabled(true);  // 重新启用
```

### 📝 LoggingInterceptor - 日志记录

```csharp
// 创建日志拦截器
var logger = new LoggingInterceptor(
    LoggingInterceptor.LogLevel.Debug, 
    enableFileLogging: true  // 启用文件日志
);

// 配置日志过滤器
logger.AddMessageFilter("Game");     // 只记录包含"Game"的消息
logger.AddMessageFilter("UI");       // 只记录包含"UI"的消息

// 忽略高频消息
logger.AddIgnoredMessage("MouseMove");
logger.AddIgnoredMessage("Update");

eventBus.AddInterceptor(logger);

// 运行时管理
logger.CurrentLogLevel = LoggingInterceptor.LogLevel.Verbose;  // 更改日志级别
logger.FlushNow();  // 手动刷新日志缓冲区

// 获取统计信息
var messageStats = logger.GetMessageStatistics();
logger.PrintStatisticsReport();
```

## 🎮 Unity Inspector 配置

使用 `InterceptorSetup` 组件时，您可以在Unity Inspector中直接配置：

### 拦截器开关
- ✅ Use Authentication Interceptor - 启用权限检查
- ✅ Use Parameter Validation Interceptor - 启用参数验证
- ✅ Use Rate Limit Interceptor - 启用频率限制
- ⬜ Use Conditional Interceptor - 启用条件拦截
- ✅ Use Logging Interceptor - 启用日志记录

### 日志配置
- **Log Level**: Info (None/Error/Warning/Info/Debug/Verbose)
- ⬜ Enable File Logging - 启用文件日志
- ⬜ Enable Verbose Logging - 启用详细日志

### 频率限制配置
- **Default Rate Limit Ms**: 100 (默认间隔毫秒)
- ⬜ Enable Rate Limit Logging - 启用频率限制日志

### 用户权限配置
- ⬜ Default User Is Admin - 默认用户是管理员
- ✅ Default User Is Logged In - 默认用户已登录
- **Default Username**: "DefaultUser" - 默认用户名

## 🔧 预设配置模式

### 开发模式
```csharp
setup.ApplyDevelopmentConfiguration();
```
- ❌ 权限检查 (开发时无需权限验证)
- ✅ 参数验证 (帮助发现参数错误)
- ❌ 频率限制 (开发时无需限制)
- ❌ 条件拦截 (避免干扰开发)
- ✅ 详细日志 (完整的调试信息)
- ✅ 文件日志 (保存日志到文件)

### 生产模式
```csharp
setup.ApplyProductionConfiguration();
```
- ✅ 权限检查 (安全保护)
- ✅ 参数验证 (防止错误数据)
- ✅ 频率限制 (防止滥用)
- ✅ 条件拦截 (优化性能)
- ⚠️ 警告级别日志 (只记录重要信息)
- ❌ 文件日志 (减少IO开销)

### 调试模式
```csharp
setup.ApplyDebugConfiguration();
```
- ✅ 权限检查 (测试权限逻辑)
- ✅ 参数验证 (验证数据正确性)
- ✅ 频率限制 (测试频率控制)
- ❌ 条件拦截 (避免干扰调试)
- 🔍 调试级别日志 (详细调试信息)
- ✅ 文件日志 (保存调试记录)

## 📊 监控和调试

### 运行时统计
```csharp
// 获取拦截器管理器
var interceptorManager = eventBus.GetInterceptorManager();
var interceptors = interceptorManager.GetInterceptors();

Debug.Log($"已注册拦截器数量: {interceptors.Count}");

// 打印详细统计
setup.PrintDetailedStatistics();

// 各拦截器独立统计
authInterceptor.PrintPermissionReport();
rateLimit.PrintStatisticsReport();
conditional.PrintConfigurationReport();
logger.PrintStatisticsReport();
```

### 测试拦截器
```csharp
// 使用内置测试方法
setup.TestInterceptors();

// 或手动测试
eventBus.Post("TestMessage", "data");        // 普通消息
eventBus.Post("AdminCommand", "admin");      // 管理员消息
eventBus.Post("UserLogin");                  // 无效参数
eventBus.Post("UserLogin", "user", "pass");  // 有效登录
eventBus.Post("HighFrequencyUpdate");        // 高频消息
eventBus.Post("HighFrequencyUpdate");        // 立即重发 (测试频率限制)
```

## 🎯 最佳实践

### 1. 拦截器顺序
系统会自动按优先级排序拦截器：
1. **AuthenticationInterceptor** (优先级: 100) - 优先进行权限检查
2. **ParameterValidationInterceptor** (优先级: 0) - 验证参数有效性
3. **RateLimitInterceptor** (优先级: 0) - 控制发送频率
4. **ConditionalInterceptor** (优先级: 0) - 条件过滤
5. **LoggingInterceptor** (优先级: 1) - 最后记录日志

### 2. 性能考虑
- 在生产环境中使用 `Warning` 或 `Error` 日志级别
- 合理设置频率限制，避免过于严格影响用户体验
- 对高频消息添加到日志忽略列表
- 条件拦截器的自定义条件要保持简单快速

### 3. 安全建议
- 生产环境必须启用权限检查拦截器
- 对敏感操作设置适当的权限要求
- 使用参数验证防止恶意数据注入
- 设置合理的频率限制防止DOS攻击

### 4. 调试技巧
- 开发时启用详细日志查看拦截过程
- 使用测试方法验证拦截器配置
- 定期检查统计报告了解系统运行状况
- 根据需要动态调整拦截器配置

## 🚨 常见问题

### Q: 为什么我的消息被拦截了？
A: 检查以下几点：
1. 用户是否有足够权限 (`authInterceptor.PrintPermissionReport()`)
2. 参数是否有效 (检查参数数量和类型)
3. 是否触发频率限制 (`rateLimit.PrintStatisticsReport()`)
4. 是否被条件拦截器阻止 (`conditional.PrintConfigurationReport()`)

### Q: 如何临时禁用某个拦截器？
A: 
```csharp
// 方法1: 移除拦截器
eventBus.RemoveInterceptor(interceptor);

// 方法2: 禁用条件拦截器
conditional.IsEnabled = false;

// 方法3: 使用Setup组件
setup.SetConditionalInterceptorEnabled(false);
```

### Q: 日志文件在哪里？
A: 日志文件保存在 `Application.persistentDataPath/Logs/` 目录下，文件名格式为 `EventLog_yyyyMMdd_HHmmss.txt`

### Q: 如何自定义权限提供者？
A: 实现 `IUserPermissionProvider` 接口：
```csharp
public class CustomPermissionProvider : IUserPermissionProvider
{
    public bool IsUserAdmin() => YourUserManager.IsAdmin;
    public bool IsUserLoggedIn() => YourUserManager.IsLoggedIn;
    public bool HasPermission(string permission) => YourUserManager.HasPermission(permission);
    public string GetCurrentUserInfo() => YourUserManager.GetUserInfo();
}
```

这套拦截器系统为您的事件系统提供了企业级的消息处理能力，确保系统的安全性、稳定性和可维护性！